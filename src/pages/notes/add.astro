---
import Layout from '../../layouts/Layout.astro';
import Modal from '../../components/Modal.astro';

const today = new Date().toISOString().split('T')[0];
---

<Layout title="Add Note - DevNotes">
  <div class="px-4 py-8 sm:px-6 lg:px-8 max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
        âœ¨ Add New Note
      </h1>
      <p class="text-gray-600 dark:text-gray-300">
        Create a comprehensive note with detailed explanations, code examples, and insights.
      </p>
    </div>

    <!-- Add Note Form -->
    <div class="card p-6">
      <form id="note-form" class="space-y-6">
        <!-- Title -->
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Note Title *
          </label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            required
            placeholder="e.g., Complete Guide to React Hooks"
            class="search-input w-full"
          >
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Brief description *
          </label>
          <textarea 
            id="description" 
            name="description" 
            rows="3"
            required
            placeholder="A concise description of what this note covers..."
            class="search-input w-full resize-none"
          ></textarea>
        </div>

        <!-- Date -->
        <div>
          <label for="date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Date *
          </label>
          <input 
            type="date" 
            id="date" 
            name="date" 
            required
            value={today}
            class="search-input w-full"
          >
        </div>

        <!-- Category and Difficulty -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Category *
            </label>
            <select 
              id="category" 
              name="category" 
              required
              class="search-input w-full"
            >
              <option value="">Select a category</option>
              <option value="frontend">Frontend</option>
              <option value="backend">Backend</option>
              <option value="devops">DevOps</option>
              <option value="database">Database</option>
              <option value="tools">Tools</option>
              <option value="algorithms">Algorithms</option>
              <option value="design">Design</option>
              <option value="ai">AI</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div>
            <label for="difficulty" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Difficulty Level *
            </label>
            <select 
              id="difficulty" 
              name="difficulty" 
              required
              class="search-input w-full"
            >
              <option value="">Select difficulty</option>
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </div>
        </div>

        <!-- Tags -->
        <div>
          <label for="tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Tags (comma-separated)
          </label>
          <input 
            type="text" 
            id="tags" 
            name="tags" 
            placeholder="e.g., javascript, react, hooks, frontend"
            class="search-input w-full"
          >
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
            Separate multiple tags with commas
          </p>
        </div>

        <!-- Content -->
        <div>
          <label for="content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Note Content *
          </label>
          <textarea 
            id="content" 
            name="content" 
            rows="12"
            required
            placeholder="Write your detailed note here. You can include code examples, explanations, diagrams, and any other relevant content..."
            class="search-input w-full resize-none"
          ></textarea>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
            Use markdown for formatting (## for headings, ``` for code blocks, etc.)
          </p>
        </div>

        <!-- Submit Button -->
        <div class="flex gap-4 pt-4">
          <button 
            type="submit" 
            id="submit-btn"
            class="btn-primary flex-1 flex items-center justify-center gap-2"
          >
            <span id="submit-text">ðŸ’¾ Create Note</span>
            <svg id="loading-spinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
          <a 
            href="/notes" 
            class="btn-secondary flex-1 text-center"
          >
            Cancel
          </a>
        </div>
      </form>
    </div>

    <!-- Tips Section -->
    <div class="mt-8 card p-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        ðŸ’¡ Tips for Great Notes
      </h3>
      <ul class="space-y-2 text-gray-600 dark:text-gray-300">
        <li class="flex items-start">
          <span class="text-primary-600 mr-2">â€¢</span>
          <span>Start with a clear, descriptive title</span>
        </li>
        <li class="flex items-start">
          <span class="text-primary-600 mr-2">â€¢</span>
          <span>Write a concise but informative description</span>
        </li>
        <li class="flex items-start">
          <span class="text-primary-600 mr-2">â€¢</span>
          <span>Include practical code examples and use cases</span>
        </li>
        <li class="flex items-start">
          <span class="text-primary-600 mr-2">â€¢</span>
          <span>Use proper markdown formatting for better readability</span>
        </li>
        <li class="flex items-start">
          <span class="text-primary-600 mr-2">â€¢</span>
          <span>Add relevant tags to make your note discoverable</span>
        </li>
        <li class="flex items-start">
          <span class="text-primary-600 mr-2">â€¢</span>
          <span>Consider your audience when choosing difficulty level</span>
        </li>
      </ul>
    </div>
  </div>

  <script>
    const form = document.getElementById('note-form') as HTMLFormElement;
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      const submitText = document.getElementById('submit-text');
      const loadingSpinner = document.getElementById('loading-spinner');
      
      // Show loading state
      submitBtn.disabled = true;
      submitText.textContent = 'Creating...';
      loadingSpinner?.classList.remove('hidden');
      
      // Convert form data to JSON
      const formData = new FormData(form);
      const jsonData = {};
      for (const [key, value] of formData.entries()) {
        jsonData[key] = value;
      }
      
      try {
        console.log('Submitting note form data...');
        const response = await fetch('/api/add-note', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(jsonData)
        });
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response result:', result);
        
        if (result.success) {
          window.Modal.show('notification-modal', 'Note created successfully! The page will reload to show your new note.', 'Success', 'success');
          window.location.href = '/notes';
        } else {
          window.Modal.show('notification-modal', `Error: ${result.message}`, 'Error', 'error');
          console.error('API Error:', result);
          // Reset button state
          submitBtn.disabled = false;
          submitText.textContent = 'ðŸ’¾ Create Note';
          loadingSpinner?.classList.add('hidden');
        }
      } catch (error) {
        window.Modal.show('notification-modal', 'Error creating note. Please try again.', 'Error', 'error');
        console.error('Error:', error);
        // Reset button state
        submitBtn.disabled = false;
        submitText.textContent = 'ðŸ’¾ Create Note';
        loadingSpinner?.classList.add('hidden');
      }
    });

    // Auto-resize textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
    });
  </script>

  <!-- Modal for notifications -->
  <Modal id="notification-modal" title="Notification" type="info" />
</Layout> 